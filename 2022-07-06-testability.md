---
layout: post
title: "如何提高軟體可測試性 (Testability)"
author: "Kai-Sheng"
permalink: /articles/testability
categories: [Design, Unit-testing]
image: /assets/image/testability.png
--- 
 
眾所皆知，寫單元測試有非常多好處，但有些主管會問，為什麼寫測試會讓工程師額外花這麼多時間？除了本身對單元測試技術不熟悉以外，追根究柢是因為產品程式碼的可測試性太低，導致工程師寫測試時很難將精力投入在對的地方，甚至放棄寫單元測試。要寫出優秀的單元測試有一定的難度與門檻，關鍵就在於工程師要思考如何提高程式碼的可測試性，進而讓寫單元測試變得簡單。


## **什麼是軟體的可測試性?**

軟體可測試性的定義有多種版本，比較著名的如微軟的測試架構師 Dave Catlett 提出的 SOCK Model。雖然各家定義不同，但概念幾乎都圍繞在同一件事，就是**指一個軟體在一給定的測試環境下，能夠被測試的難易程度，或是投入測試成本的多寡**。

我們不難察覺到**程式的可測試性與設計品質是高度相關的**，例如低內聚高耦合、充滿臭味(code smell)的程式通常都難以測試，因此若能提高可測試性，讓工程師們能撰寫更多有用、高價值的 test case，就容易在開發過程中快速發現並消除 bug。

可測試性高的程式通常具備幾個關鍵特質：

### **設計單純**
若待測程式只專注做一件事，則它需要被測試的事情、情境也相對單純，且可讀性、表達力也會較佳。因此將程式設計得越單純、簡單越好（KISS 原則）。反之，越是複雜、不單純的程式就越難測試。複雜的程式例如過於冗長的 method，我的建議是 method 不可以過長，行數應限制在 30 行以內才算合格。

### **容易初始化**
意即在單元測試中可以很簡單的初始化待測程式，這種情況下，通常待測程式的相依物件不多，也能很輕易的隔絕外部依賴。若難以初始化，則表示它可能是個 God Object。容易初始化是撰寫單元測試的第一步，如果連這點都很難做到，那就得不到寫單元測試帶來的好處了。

### **輸入資料容易被控制**
這意味著我們在單元測試中能夠輕易的模擬出不同的測試情境。舉個例子：某銀行系統在客戶提款超過1億元時會對銀行內發出警告通知。這時我們可以在單元測試中控制顧客的提款金額，以便模擬顧客大額提款的情境，而不必真的事先在銀行帳戶準備一筆鉅款。在 Java 的測試中，實務上會透過 mock 技術來模擬各種情境以提高程式的可控制程度。如果程式能有效被控制住，就能被不斷的重複執行測試，加上 CI （Continuous Integration） Server，就能達到自動化測試的境界。
 
### **輸出結果容易被驗證**
程式對於任何一項操作都要能產生預期的輸出，而輸出的表現形式通常是可預期的回傳值、內部狀態、外在行為，不管是以什麼方式表現，至少都要有跡可循，才容易被驗證。若能容易的驗證程式結果是否符合預期，就能降低測試的難度，例如只用 `assertEqual()`, `verify()` 等簡單驗證方法就能得出測試結果。如果程式的輸出結果不容易被驗證，就代表不容易被測試。

----- 

## **軟體可測試性的重要**
軟體可測試性高，通常就意味著程式碼的品質也高，做出來的產品才會好用。

軟體可測試性高，就容易測試左移。測試左移本質上是要儘早發現、預防問題。若能越早發現問題，解決問題的成本就越便宜，我們就能更快速的交付產品給客戶、更快速得到客戶的 feedback，更符合敏捷開發的精神。

若軟體可測試性低，工程師就要花很多時間寫測試，通常在這種情況所寫的單元測試也會是一團亂，不僅測試效果不佳，也不容易測到關鍵、動不動就 test fail，導致測試品質低落。**若寫測試像是一門賠本生意，就會讓工程師不願意寫測試，或者拖到很晚才開始寫測試，這些都違背了測試左移的原則以及單元測試的初衷**。

----- 

## **如何提高軟體可測試性**

### **Test-Driven Development (TDD)**

TDD 是一種**先從使用者角度寫測試，再回頭撰寫產品程式碼的開發手法**。因為 TDD 讓開發者換位思考，從使用者的角度出發，就更容易了解到該怎麼設計才能讓 class / API 更易用。為了先寫出測試，開發者就必須先去思考如何進行測試，他不僅了解需求，還要逐步解構需求成一個個單純、小的 test case。若熟練 TDD 技術，就能大幅提高軟體可測試性。

TDD 是一門高深的學問，之後我會再寫一篇文章專門介紹 TDD。

### **符合 Single Responsibility Principle(SRP)**

單一職責意味著每個 class 應該有一個且只有一個職責（或被改變的理由），也意味著內聚力較高。這些都使得單元測試更容易。

首先，它是關於選擇正確的概念進行操作。在域級別上，這些是您的問題空間的概念。這些概念在很大程度上是相互獨立的。當您談論購買物品時，您不會考慮它的存儲方式。這些概念的實現也應該彼此獨立。 如果您更改數據庫，則不必修復使用數據庫功能的每個地方。

一個 class 如果顆粒度太大，同時實現了好幾個功能，會大大提升測試的難度，一來這是因為功能多必然入參數也多，測試的時候參數初始化難度就會變大，二來結果驗證的關注點也會同時變多，容易出現更多的組合驗證，嚴重的時候會出現組合爆炸。

以剛才某銀行系統的例子，提款功能應屬於 `WithdrawService` 的職責，發出內部警示功能應屬於 `NotificationService` 的職責，兩者各司其職、權責分明、彼此獨立，不應互相干涉。


### **移除 anti-pattern (bad smell)**
參數太多
不一致命名規則
代碼重複
Shotgun surgery:
要清晰的架構
避免 long method

時常 code review, Refactoring
 

### **符合 YAGNI 原則**
程式開發者應該在面臨確鑿的需求時，才實作相應的功能

https://kaisheng714.github.io/articles/yagni-principle

### **Dependency injection**
makes mocking easier

最近十年來很流行的Dependency Injection或是Inversion of Control設計原則，因為藉由外部注入相依性物件提升了待測程式的可控制性，不但提升了執行期間改變系統行為的彈性，也因此提升了可測試性。

避免高耦合 避免混雜 new 與邏輯

依賴注入把對象構建與對象注入分開。因此創建對象的 new 關鍵字也可消失了。

可用工廠方法

可以參考[分析 Spring 的依賴注入模式](/articles/analyzing-dependency-injection-patterns-in-spring)

### **避免在 constructor 中包含任何邏輯**
constructor 應該只專注於初始化，而不會有任何邏輯。若 constructor 不僅初始化，還呼叫 API、查詢 DB，初始化變得很困難，可測試性就降低了。

在單元測試中想要改寫或是 mock constructor 是不容易的，雖然現在有些測試框架可以替換 constructor 的行為，但通常不建議使用。

一個好的 constructor 應該像是這樣的:

```java
    public BankService(WithdrawService withdrawService, DepositeService depositeService) {
        this.withdrawService = withdrawService;
        this.depositeService = depositeService;
    }
```
 
### **避免使用 singleton / static**
要在測試中替換一個靜態方法的行為,是非常困難的。
要處理這種情況,我們可以使用抽取和重寫的方法進行重構,把這個靜態方法抽像出去。
一個更為極端的做法是:避免使用任何的靜態方法。這樣的話,每一段邏輯都是一個類實例的一部分,使得這段邏輯更容易替換。有些進行單元測試或者測試驅動開發的人不喜歡使用單例,原因之一就是單例缺少可替換性。單例是靜態的公共共享資源,很難重寫它們。
要完全避免使用靜態方法可能會過於困難,但是你可以嘗試在應用程序中盡量少使用單例或者靜態方法,這樣在測試時會變得容易一些。
 
----- 

## **結語**

把「寫自動化單元測試程式碼很困難」當成理由的人，其主要的原因不是出在測試程式碼，而是在被測程式上。

公司很多人在實踐單元測試中總覺的很困難的一個很重要的原因就是其代碼本身不具有可測試性。他們往往會走入一個誤區。面對一個幾千行、邏輯混亂的方法而抓耳撓腮的想著用十八般武藝，各種框架去寫這個方法的單元測試，而最終不得不以失敗而告終，耗費了大量的時間卻徒勞而無功。其實是他們忽略了這個方法的本身是不具有可測試性的。 讓測試的結果驗證變得困難，

整個團隊的觀念、基本功如果沒有到位，要在組織內推動單元測試是很困難的。 即使觀念到位了，同時還要其他的條件配合（例如客戶，專案時程等）

而更重要的是，能被自動化測試的程式，通常具備了好的設計特質，而好的設計特質也能帶來好的可測試性。因此，對程式設計者來說，你值得花點心思想一想，和了解各種增加可測試性的方式和手法。

TDD搭配持續整合(CI)一同使用，可以提升團隊開發的效率。提高可測試性，才能有好的測試程式，才有辦法享受自動化測試帶來的甜美果實。


### **References**

https://en.wikipedia.org/wiki/Software_testability

https://docs.microsoft.com/zh-tw/archive/msdn-magazine/2008/december/patterns-in-practice-design-for-testability

https://teddy-chen-tw.blogspot.com/2013/04/blog-post_4.html

https://www.ithome.com.tw/voice/88062

https://www.youtube.com/watch?v=fr1E9aVnBxw

https://www.youtube.com/watch?v=wEhu57pih5w

[不建議使用 PowerMock 的理由](/articles/drawback-of-powermock)