---
layout: post
title: "如何提高軟體可測試性 (Testability)"
author: "Kai-Sheng"
permalink: /articles/testability
categories: [Design, Unit-testing]
image: /assets/image/testability.png
--- 
 
眾所皆知，撰寫單元測試有很多好處，但有些主管會問，為什麼寫測試會讓工程師額外花這麼多時間，讓評估工時變得越來越難? 除了本身對單元測試技術不熟悉以外，追根究柢是因為產品程式碼的可測試性太低，導致工程師寫測試時很難將精力投入在對的地方，甚至放棄寫單元測試。寫出優秀的單元測試是有一定的難度，關鍵在於工程師要思考如何提高程式碼的可測試性，進而讓寫單元測試變得簡單。


## **什麼是軟體的可測試性?**

軟體可測試性的定義有多種版本，比較著名的如微軟的測試架構師 Dave Catlett 提出的 SOCK Model。雖然各家定義不同，但概念幾乎都圍繞在同一件事，就是**指一個軟體在一給定的測試環境下，能夠被測試的難易程度，或需花費多少測試成本**。

我們不難察覺到**程式的可測試性與設計品質是高度相關的**，例如低內聚高耦合、充滿臭味(code smell)的程式通常都難以測試，因此若能提高可測試性，進寫撰寫更多關鍵的 test case，就容易在開發過程中快速發現並消除 bug。

可測試性高的程式通常具備幾個特質：

### **單純**
若程式只專注做一件事，則需要被測試的事情、情境也相對單純，可讀性、表達力也較高。因此將程式設計得越單純、簡單越好(KISS 原則)。反過來說，越是複雜、不單純的程式就越難測試。

### **容易初始化**
意即在單元測試中可以很簡單的初始化待測程式，這種情況下，通常待測程式的相依物件不多，也能很輕易的隔絕外部依賴。這是撰寫單元測試的第一步，如果連這點都很難做到，那就得不到寫單元測試帶來的好處了。

### **容易被控制**
這意味著我們在單元測試中能夠輕易的模擬出不同的測試情境。舉個例子：某銀行系統在客戶提款超過1億元時會對銀行內發出警告通知。這時我們可以在單元測試中控制提款金額，來模擬顧客大額提款的情境，而不必真的事先在銀行帳戶準備一筆鉅款。實務上會透過 mock 技術來模擬各種情境以提高程式的可控制程度。如果程式被控制住，就能被不斷的重複執行測試，若再加上 CI (Continuous Integration) Server，就能達到自動化測試的境界。
 
### **容易被驗證**
容易驗證程式的結果是否符合預期，才能降低測試的難度，例如只用 `assertEqual()`, `assertTrue()` 等簡單驗證方法就能得出測試結果。如果待測程式的回傳值、內部狀態、外在行為不容易被驗證，那麼這個程式就不容易測試。

----- 

## **軟體可測試性的重要**
軟體可測試性高，通常就意味著程式碼的品質也高，做出來的產品才會好用。

軟體可測試性高，就容易測試左移，測試左移本質上是要儘早發現、預防問題，越早發現問題，解決問題就越便宜，才能更快交付產品給客戶。

若軟體可測試性低，工程師就要花很多時間寫測試，但結果通常測試效果不佳、動不動就 test fail，導致測試品質低落，若寫測試像是一門賠本生意，就會讓工程師不願意做測試，或者拖到很晚才開始寫測試，這些都違背了測試左移的原則以及寫單元測試的初衷。

----- 

## **如何提高軟體可測試性**

### **1. Test-Driven Development (TDD)**

TDD 是一種**先寫測試再開發程式的開發技巧**，

TDD 是先從使用者角度寫測試，再回頭撰寫程式碼。為了先寫出測試，開發者就必須先去思考如何進行測試，他必須了解需求，逐步解構需求，將一個複雜的需求拆成一個個小的 test case。

TDD 讓開發者換位思考，從使用者的角度出發，了解到該怎麼設計才能讓我的 class / API 更好用 ?

TDD 會讓開發者意識到那些事物是必要的、什麼是不必要的 ? 

TDD 是一門高深的學問，之後我會再專門寫一篇文章介紹 TDD。


### **2. 符合 SRP**

Make sure all of your classes follow the Single Responsibility Principle. Single responsibility means that each class should have one and only one responsibility. That makes unit testing much easier.

一个函数如果颗粒度太大，同时实现了好几个功能，会大大提升测试的难度，一来这是因为功能多必然入参也多，测试的时候参数初始化难度就会变大，二来结果验证的关注点也会同时变多，容易出现更多的组合验证，严重的时候会出现组合爆炸。

避免 long method

### **移除 anti-pattern (bad smell)**

不一致的排版與命名規則
太多的參數
代碼重複
Shotgun surgery:
沒有清晰結構的系統


### **3. Dependency injection**
makes mocking easier

最近十年來很流行的Dependency Injection或是Inversion of Control設計原則，因為藉由外部注入相依性物件提升了待測程式的可控制性，不但提升了執行期間改變系統行為的彈性，也因此提升了可測試性。

### **4. 避免在 constructor 中做事**
constructor 應該只專注於初始化，而不會有任何邏輯。 Mock constructor 是不容易的

### **5. 避免混雜 new 與邏輯**
避免高耦合
可用工廠方法

### **6. 避免使用 singleton / static**
要在測試中替換一個靜態方法的行為,是非常困難的。
要處理這種情況,我們可以使用抽取和重寫的方法進行重構,把這個靜態方法抽像出去。
一個更為極端的做法是:避免使用任何的靜態方法。這樣的話,每一段邏輯都是一個類實例的一部分,使得這段邏輯更容易替換。有些進行單元測試或者測試驅動開發的人不喜歡使用單例,原因之一就是單例缺少可替換性。單例是靜態的公共共享資源,很難重寫它們。
要完全避免使用靜態方法可能會過於困難,但是你可以嘗試在應用程序中盡量少使用單例或者靜態方法,這樣在測試時會變得容易一些。
 
----- 

## **結語**

把「寫自動化單元測試程式碼很困難」當成理由的人，其主要的原因不是出在測試程式碼，而是在被測程式上。

公司很多人在實踐單元測試中總覺的很困難的一個很重要的原因就是其代碼本身不具有可測試性。他們往往會走入一個誤區。面對一個幾千行、邏輯混亂的方法而抓耳撓腮的想著用十八般武藝，各種框架去寫這個方法的單元測試，而最終不得不以失敗而告終，耗費了大量的時間卻徒勞而無功。其實是他們忽略了這個方法的本身是不具有可測試性的。 讓測試的結果驗證變得困難，


整個團隊的觀念、基本功如果沒有到位，要在組織內推動單元測試是很困難的。 即使觀念到位了，同時還要其他的條件配合（例如客戶，專案時程等）

而更重要的是，能被自動化測試的程式，通常具備了好的設計特質，而好的設計特質也能帶來好的可測試性。因此，對程式設計者來說，你值得花點心思想一想，和了解各種增加可測試性的方式和手法。

TDD搭配持續整合(CI)一同使用，可以提升團隊開發的效率。提高可測試性，才能有好的測試程式，才有辦法享受自動化測試帶來的甜美果實。


### **References**

https://en.wikipedia.org/wiki/Software_testability

https://docs.microsoft.com/zh-tw/archive/msdn-magazine/2008/december/patterns-in-practice-design-for-testability

https://teddy-chen-tw.blogspot.com/2013/04/blog-post_4.html

https://www.ithome.com.tw/voice/88062

https://www.youtube.com/watch?v=fr1E9aVnBxw

https://www.youtube.com/watch?v=wEhu57pih5w